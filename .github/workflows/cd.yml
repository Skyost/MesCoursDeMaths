name: Continuous Delivery

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        node: [ 16 ]
        pandoc: [ 2.18 ]
    steps:
      - name: Checkout üõé
        uses: actions/checkout@v3
      - name: Setup Node.js ${{ matrix.node-version }} üèó
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Install dependencies üë®üèª‚Äçüíª
        run: npm ci
      - name: Install pandoc üìÑ
        run: |
          wget https://github.com/jgm/pandoc/releases/download/${{ matrix.pandoc }}/pandoc-${{ matrix.pandoc }}-1-amd64.deb
          sudo dpkg -i pandoc-${{ matrix.pandoc }}-1-amd64.deb
          rm pandoc-${{ matrix.pandoc }}-1-amd64.deb
          pandoc -v
      - name: Install Poppler üñº
        run: |
          sudo apt install poppler-utils
          pdftocairo -v
      - name: Install latexmk üìè
        run: |
          wget -O latexmk https://mirrors.ircam.fr/pub/CTAN/support/latexmk/latexmk.pl
          chmod +x latexmk
          sudo ln -s "${PWD}/latexmk" /usr/bin/latexmk
          latexmk -v
      - name: Install TeXLive üñã
        run: |
          sudo apt install -y unzip
          wget http://mirror.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz
          tar xvzf install-tl-unx.tar.gz
          rm install-tl-unx.tar.gz
          cd install-tl-*
          touch texlive.profile
          echo 'selected_scheme scheme-full
          TEXDIR /tmp/texlive
          TEXMFCONFIG ~/.texlive/texmf-config
          TEXMFHOME ~/texmf
          TEXMFLOCAL /tmp/texlive/texmf-local
          TEXMFSYSCONFIG /tmp/texlive/texmf-config
          TEXMFSYSVAR /tmp/texlive/texmf-var
          TEXMFVAR ~/.texlive/texmf-var
          option_doc 0
          option_src 0' > texlive.profile
          ./install-tl --profile=texlive.profile
          sudo ln -s /tmp/texlive/bin/x86_64-linux /opt/texbin
          pathmunge () {
            if ! echo $PATH | /bin/egrep -q "(^|:)$1($|:)" ; then
            if [ "$2" = "after" ] ; then
            PATH=$PATH:$1
            else
            PATH=$1:$PATH
            fi
            fi
          }
          pathmunge /opt/texbin
          unset pathmunge
          sudo cp $(kpsewhich -var-value TEXMFSYSVAR)/fonts/conf/texlive-fontconfig.conf /etc/fonts/conf.d/09-texlive.conf
          sudo fc-cache -fsv
          cd ../
          luatex --version
      - name: Generate ‚öôÔ∏è
        run: npm run generate
        env:
          GITHUB_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          GITHUB_PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Deploy üöÄ
        uses: JamesIves/github-pages-deploy-action@v4.3.3
        with:
          folder: dist
          branch: gh-pages
          single-commit: true
